import { NextRequest, NextResponse } from 'next/server';
import * as fal from "@fal-ai/serverless-client";
import { SYSTEM_PROMPT, NEGATIVE_PROMPT } from '@/lib/prompt-builder';

// 配置 Fal.ai
fal.config({
  credentials: process.env.FAL_KEY,
});

export async function POST(request: NextRequest) {
  try {
    const { prompt } = await request.json();

    if (!prompt) {
      return NextResponse.json(
        { error: 'Prompt is required' },
        { status: 400 }
      );
    }

    console.log('=== Fusion Generation Request ===');
    console.log('User Prompt (Layer 2+3):', prompt);

    // 三层Prompt拼接
    const fullPrompt = `${SYSTEM_PROMPT}

${prompt}`;

    console.log('\n=== Full Prompt to Fal.ai ===');
    console.log(fullPrompt);
    console.log('\n=== Negative Prompt ===');
    console.log(NEGATIVE_PROMPT);

    // Fal.ai API 调用
    const result: any = await fal.run("fal-ai/flux/dev", {
      input: {
        prompt: fullPrompt,
        negative_prompt: NEGATIVE_PROMPT,
        image_size: "square_hd",
        num_inference_steps: 32,
        guidance_scale: 6.5,
        num_images: 1,
        enable_safety_checker: true,
      },
    });

    console.log('\n=== Generation Complete ===');

    // 提取图片URL
    let imageUrl: string | undefined;
    if (result.data?.images?.[0]?.url) {
      imageUrl = result.data.images[0].url;
    } else if (result.images?.[0]?.url) {
      imageUrl = result.images[0].url;
    } else if (result.data?.image_url) {
      imageUrl = result.data.image_url;
    } else if (result.image_url) {
      imageUrl = result.image_url;
    } else {
      console.error('Unexpected result structure:', result);
      throw new Error('Invalid response structure from AI service');
    }

    console.log('Image URL:', imageUrl);

    // 返回结果
    return NextResponse.json({
      imageUrl: imageUrl,
      prompt: prompt,
      quota: {
        used: 1,
        remaining: 99,
        limit: 100,
        isVIP: false,
      }
    });

  } catch (error: any) {
    console.error('=== Generation Error ===');
    console.error('Error name:', error.name);
    console.error('Error message:', error.message);
    console.error('Full error:', error);
    
    return NextResponse.json(
      { error: error.message || error.toString() || 'Failed to generate image' },
      { status: 500 }
    );
  }
}
